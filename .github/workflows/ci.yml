name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run browser E2E job (Playwright)'
        required: false
        default: 'false'

env:
  RUN_BROWSER_E2E: ${{ github.event.inputs.run_e2e || 'false' }}

jobs:
  tests:
    name: Test (PHP ${{ matrix.php }} / Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ["8.4"]
        node: ["18"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v4
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, bcmath, xml, pcntl
          ini-values: post_max_size=256M, upload_max_filesize=256M

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Get Composer Cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist --no-interaction

      - name: Install Node dependencies (optional)
        run: |
          npm ci --no-audit --no-fund
        shell: bash

      - name: Copy environment file
        run: cp .env.example .env

      - name: Create SQLite database file
        run: php -r "file_exists('database/database.sqlite') || touch('database/database.sqlite');"

      - name: Generate application key
        run: php artisan key:generate --ansi

      - name: Run Pint (style check)
        run: vendor/bin/pint --test || vendor/bin/pint

      - name: Run Tests
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
          CACHE_DRIVER: array
          SESSION_DRIVER: array
          QUEUE_CONNECTION: sync
          MAIL_MAILER: array
        run: php artisan test --no-interaction --verbose

  e2e:
    name: Browser E2E (Playwright)
    runs-on: ubuntu-latest
    needs: tests
    if: ${{ env.RUN_BROWSER_E2E == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: npm ci --no-audit --no-fund

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup PHP (for serving app)
        uses: shivammathur/setup-php@v4
        with:
          php-version: '8.4'

      - name: Install Composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist --no-interaction

      - name: Copy environment file
        run: cp .env.example .env

      - name: Create SQLite database file
        run: php -r "file_exists('database/database.sqlite') || touch('database/database.sqlite');"

      - name: Generate application key
        run: php artisan key:generate --ansi

      - name: Run migrations
        run: php artisan migrate --force

      - name: Start Laravel server
        run: php artisan serve --port=8080 --env=testing &

      - name: Wait for server
        run: |
          for i in {1..30}; do
            if curl -sSf http://127.0.0.1:8080/ >/dev/null; then
              echo 'Server is up';
              break;
            fi
            sleep 1
          done

      - name: Run Playwright tests
        run: npx playwright test --reporter=list
        env:
          APP_URL: http://127.0.0.1:8080
